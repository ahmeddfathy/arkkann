# نظام طلبات الغياب (Absence Request System)

## الهيكل العام للنظام

نظام طلبات الغياب يتكون من ثلاثة أجزاء رئيسية:

1. **النماذج (Models)**: `AbsenceRequest.php`
2. **الخدمات (Services)**: `AbsenceRequestService.php`
3. **وحدات التحكم (Controllers)**: `AbsenceRequestController.php`
4. **واجهات المستخدم**: الملفات الموجودة في مجلد `resources/views/absence-requests`
5. **ملفات JavaScript**: الملفات الموجودة في مجلد `public/js/absence-requests`

## آلية عمل النظام

### النموذج (Model) - AbsenceRequest

يمثل طلب الغياب في قاعدة البيانات ويحتوي على:

- معلومات الطلب: التاريخ، السبب، الحالة
- علاقات مع النماذج الأخرى (مثل المستخدم)
- صلاحيات الوصول: من يستطيع إنشاء/تعديل/حذف طلبات الغياب
- حالات متعددة للموافقة: حالة المدير، حالة الموارد البشرية، الحالة النهائية

الحقول الرئيسية:
- `user_id`: معرف المستخدم مقدم الطلب
- `absence_date`: تاريخ الغياب
- `reason`: سبب الغياب 
- `status`: الحالة النهائية للطلب (معلق، موافق، مرفوض)
- `manager_status`: حالة موافقة المدير
- `hr_status`: حالة موافقة الموارد البشرية
- `manager_rejection_reason`: سبب رفض المدير (إن وجد)
- `hr_rejection_reason`: سبب رفض الموارد البشرية (إن وجد)

دوال هامة:
- `updateFinalStatus`: تحديث الحالة النهائية بناءً على حالة المدير و HR
- `canUpdate/canDelete`: تحقق من صلاحيات التعديل/الحذف
- `canModifyResponse`: تحقق من صلاحية تعديل الرد

### الخدمة (Service) - AbsenceRequestService

تحتوي على المنطق الأساسي لإدارة طلبات الغياب:

- `getAllRequests`: الحصول على جميع الطلبات حسب دور المستخدم
- `createRequest`: إنشاء طلب غياب جديد
  - إذا كان المستخدم من فريق HR، يتم اعتماد الطلب تلقائياً من ناحية HR
- `createRequestForUser`: إنشاء طلب لمستخدم آخر (للمدراء و HR)
  - إذا كان المستخدم المستهدف من فريق HR، يتم اعتماد الطلب تلقائياً من ناحية HR
  - إذا كان المستخدم الحالي (الذي ينشئ الطلب) من فريق HR، يتم اعتماد الطلب تلقائياً من ناحية HR
  - إذا كان المستخدم الحالي ليس من فريق HR، تظل حالة HR "معلقة" حتى لو كان مديراً
- `updateRequest`: تحديث طلب موجود
- `deleteRequest`: حذف طلب
- `updateStatus`: تحديث حالة الطلب (موافقة/رفض)
- `modifyResponse`: تعديل الرد على طلب
- `resetStatus`: إعادة تعيين حالة الطلب إلى معلق

### وحدة التحكم (Controller) - AbsenceRequestController

تتعامل مع طلبات HTTP وتربط بين الخدمة وواجهة المستخدم:

- `index`: عرض صفحة طلبات الغياب الرئيسية مع البيانات والإحصائيات
- `store`: إنشاء طلب غياب جديد
- `update`: تحديث طلب موجود
- `destroy`: حذف طلب
- `updateStatus`: تحديث حالة الطلب (موافقة/رفض)
- `modifyResponse`: تعديل الرد على طلب
- `resetStatus`: إعادة تعيين حالة الطلب

بالإضافة إلى دوال مساعدة:
- `getStatistics`: الحصول على إحصائيات الغياب
- `getTeamMembers`: جلب أعضاء الفريق
- `getAllowedRoles`: تحديد الأدوار المسموح بها للمستخدم

## تدفق العمل للموافقة على طلبات الغياب

1. **يقدم الموظف طلب غياب** (status: pending)
2. **يتم التحقق من الموافقات المطلوبة**:
   - إذا كان الموظف ينتمي لفريق، يحتاج الطلب لموافقة المدير و HR
   - إذا كان الموظف بدون فريق، يحتاج الطلب لموافقة HR فقط
   - **إذا كان الموظف من فريق HR** ، يتم الموافقة تلقائياً على الطلب من ناحية HR
3. **إنشاء طلب لمستخدم آخر**:
   - إذا كان المنشئ من فريق HR، يتم الموافقة تلقائياً من ناحية HR
   - إذا كان المستخدم المستهدف من فريق HR، يتم الموافقة تلقائياً من ناحية HR
   - إذا كان المنشئ ليس من فريق HR (مدير فقط)، تظل حالة HR "معلقة"
4. **رد المدير**: يمكن للمدير الموافقة (approved) أو الرفض (rejected)
5. **رد HR**: يمكن للـ HR الموافقة (approved) أو الرفض (rejected)
6. **تحديث الحالة النهائية**:
   - إذا تم رفض الطلب من أي جهة، تكون الحالة النهائية "مرفوض"
   - إذا كان الموظف ينتمي لفريق، يجب موافقة المدير و HR معاً للقبول النهائي
   - إذا كان الموظف بدون فريق، تكفي موافقة HR فقط للقبول النهائي
   - إذا كان الموظف من HR، فقط يحتاج لموافقة المدير (إذا كان في فريق)
7. **يمكن تعديل الرد**: للمدراء أو HR تعديل ردهم أو إعادة تعيين الحالة
8. **تعديل الطلبات**:
   - الموظف العادي يمكنه تعديل طلباته فقط إذا كانت في حالة "معلق"
   - **موظف HR يمكنه تعديل طلباته طالما كانت موافقة HR معتمدة**، حتى إذا كان الطلب ينتظر موافقة المدير

## الأدوار والصلاحيات

### الأدوار:
- **موظف عادي**: يمكنه فقط إنشاء وإدارة طلباته الخاصة
- **مدير فريق (team_leader)**: يمكنه الموافقة على طلبات أعضاء فريقه
- **مدير قسم (department_manager)**: يمكنه الموافقة على طلبات الأقسام التي يديرها
- **مدير شركة (company_manager)**: يمكنه الموافقة على طلبات جميع الموظفين
- **موارد بشرية (hr)**: يمكنه الموافقة على جميع الطلبات

### الصلاحيات:
- `create_absence`: إنشاء طلب غياب
- `update_absence`: تعديل طلب غياب
- `delete_absence`: حذف طلب غياب
- `manager_respond_absence_request`: الرد على طلب غياب كمدير
- `hr_respond_absence_request`: الرد على طلب غياب كـ HR

## واجهة المستخدم والتفاعل

1. **الصفحة الرئيسية (index.blade.php)**: تعرض جميع الأقسام والمكونات
2. **البحث (_search.blade.php)**: للبحث وتصفية طلبات الغياب
3. **الجدول (_table.blade.php)**: عرض طلبات الغياب في جداول مختلفة حسب الدور
4. **الإحصائيات (_statistics.blade.php)**: عرض إحصائيات ورسوم بيانية للغياب
5. **النوافذ المنبثقة (_modals.blade.php)**: نماذج لإنشاء/تعديل/الموافقة على الطلبات

## ملف JavaScript

1. **common.js**: دوال مشتركة ومساعدة
2. **index.js**: التفاعل الرئيسي مع الصفحة
3. **modals.js**: التعامل مع النوافذ المنبثقة
4. **statistics.js**: عرض الإحصائيات والبيانات
5. **hr-charts.js**: الرسوم البيانية الخاصة بـ HR

## خطأ يجب إصلاحه

في الملفات الحالية، يوجد مشكلة في استخدام الدوال `hasRole` و `hasPermissionTo`. 
هذه الدوال غير معرفة وتسبب أخطاء لغوية. 

الحل المقترح:
1. التأكد من تثبيت وإعداد حزمة Spatie Laravel Permission بشكل صحيح
2. التأكد من أن نموذج User يستخدم الـ traits المطلوبة:
```php
use Spatie\Permission\Traits\HasRoles;

class User extends Authenticatable
{
    use HasRoles;
    
    // باقي الكود
}
```

## حالات خاصة

1. **موظفي HR**:
   - يتم الموافقة تلقائياً على طلباتهم من ناحية HR
   - يمكنهم تعديل أو حذف طلباتهم طالما أن موافقة HR معتمدة (حتى لو كان الطلب ينتظر موافقة المدير)
   - عند تعديل الطلب، تظل موافقة HR معتمدة ولا تتغير إلى "معلق" مرة أخرى
   - **تظهر أزرار التعديل والحذف في واجهة المستخدم** لموظفي HR طالما أن موافقة HR معتمدة، على عكس الموظفين العاديين الذين تظهر لهم الأزرار فقط عندما تكون جميع الحالات "معلق"

2. **إنشاء طلب لمستخدم آخر**:
   - عندما ينشئ مدير طلباً لموظف، يتم الموافقة تلقائياً من ناحية المدير
   - لكن حالة HR ستكون "معلقة" إلا إذا كان المدير من فريق HR أو المستخدم المستهدف من فريق HR
   - هذا يضمن عدم تخطي موافقة HR إلا في الحالات المناسبة

## تحديث واجهة المستخدم

تم تعديل شروط ظهور الأزرار في ملف `_table.blade.php` كالتالي:

1. **أزرار التعديل والحذف**:
   - للموظفين العاديين: تظهر فقط إذا كانت حالة المدير و HR هي "معلق"
   - لموظفي HR: تظهر إذا كانت موافقة HR معتمدة، بغض النظر عن حالة موافقة المدير

```php
@if((Auth::id() === $request->user_id && $request->manager_status === 'pending' && $request->hr_status === 'pending' && $canUpdateAbsence) ||
    (Auth::id() === $request->user_id && Auth::user()->hasRole('hr') && $request->hr_status === 'approved' && $canUpdateAbsence))
    <!-- أزرار التعديل -->
@endif
```

هذا يسمح لموظفي HR بالاستمرار في تعديل طلباتهم حتى بعد الموافقة التلقائية من جانب HR، طالما أن حالة HR لا تزال "موافق".
