# نظام إدارة طلبات الاستئذان

## مقدمة

نظام طلبات الاستئذان هو نظام متكامل لإدارة طلبات الموظفين للخروج المؤقت أثناء ساعات العمل. يتيح النظام للموظفين تقديم طلبات استئذان، ويمكّن المدراء وموظفي الموارد البشرية من مراجعة الطلبات والموافقة عليها أو رفضها.

## الأدوار والصلاحيات

- **الموظف**: يمكنه تقديم طلبات استئذان ومتابعتها وتسجيل عودته
- **قائد الفريق**: يمكنه الموافقة/رفض طلبات أعضاء فريقه وتسجيل عودتهم
- **مدير القسم**: يمكنه الموافقة/رفض طلبات فريقه وفرق قادة الفرق وتسجيل عودتهم
- **مدير الشركة**: يمكنه الموافقة/رفض الطلبات لمستويات متعددة من الموظفين وتسجيل عودتهم
- **موارد بشرية**: يمكنهم الموافقة/رفض جميع الطلبات وخاصة الموظفين غير المنتمين لفرق وتسجيل عودتهم

## دورة حياة طلب الاستئذان

1. **تقديم الطلب**: يقدم الموظف طلب الاستئذان محدداً وقت المغادرة ووقت العودة والسبب
2. **مراجعة المدير**: يراجع المدير المباشر الطلب ويوافق/يرفض
3. **مراجعة الموارد البشرية**: تراجع الموارد البشرية الطلب وتوافق/ترفض
4. **الموافقة النهائية**: يتم الموافقة النهائية عندما يوافق كل من المدير والموارد البشرية
5. **تنفيذ الاستئذان**: الموظف يغادر ويعود حسب الموافقة
6. **تسجيل العودة**: يسجل الموظف عودته بنفسه أو يقوم المدير بتسجيلها يدوياً

## قيود النظام

- الحد المجاني للاستئذان: 180 دقيقة (3 ساعات) شهرياً لكل موظف
- يمكن للموظف تجاوز الحد الشهري المجاني (180 دقيقة) مع ظهور تنبيه
- لا يمكن الاستئذان قبل بداية الدوام أو بعد نهايته
- لا يمكن تقديم طلبين متداخلين في الوقت
- **يجب تسجيل العودة يدوياً**: لا يوجد تسجيل تلقائي لعدم العودة عند انتهاء الوردية

## أمثلة واقعية

### مثال 1: تقديم طلب استئذان

الموظف "أحمد" يريد الخروج للذهاب إلى البنك من الساعة 10:00 صباحاً حتى 11:30 صباحاً.

```javascript
// Frontend (طريقة إرسال الطلب من واجهة المستخدم)
const requestData = {
    departure_time: '2023-10-15 10:00:00',
    return_time: '2023-10-15 11:30:00',
    reason: 'زيارة البنك لإتمام معاملة مصرفية'
};

// إرسال الطلب
axios.post('/permission-requests', requestData).then(response => {
    if (response.data.success) {
        showNotification('تم إنشاء طلب الاستئذان بنجاح');
    } else {
        showError(response.data.message);
    }
});
```

### مثال 2: الموافقة على طلب استئذان

المدير "سارة" تريد الموافقة على طلب استئذان أحد موظفيها.

```javascript
// Frontend (موافقة المدير)
const responseData = {
    response_type: 'manager', // نوع الرد (مدير)
    status: 'approved',       // الحالة (موافقة)
    rejection_reason: ''      // سبب الرفض (فارغ في حالة الموافقة)
};

axios.post(`/permission-requests/${requestId}/update-status`, responseData).then(response => {
    if (response.data.success) {
        showNotification('تمت الموافقة على طلب الاستئذان');
        updateRequestsList();
    }
});
```

### مثال 3: رفض طلب استئذان

مسؤول الموارد البشرية "محمد" يرفض طلب استئذان لتجاوز الحد الشهري.

```javascript
// Frontend (رفض الموارد البشرية)
const responseData = {
    response_type: 'hr',                        // نوع الرد (موارد بشرية)
    status: 'rejected',                         // الحالة (رفض)
    rejection_reason: 'تجاوز الحد الشهري المسموح' // سبب الرفض
};

axios.post(`/permission-requests/${requestId}/update-status`, responseData).then(response => {
    if (response.data.success) {
        showNotification('تم رفض طلب الاستئذان');
        updateRequestsList();
    }
});
```

### مثال 4: تسجيل العودة

الموظف "أحمد" يعود من الاستئذان ويسجل عودته بالنظام.

```javascript
// Frontend (تسجيل العودة)
const returnData = {
    return_status: 1  // 1 = عاد، 2 = لم يعد، 0 = إعادة تعيين
};

axios.post(`/permission-requests/${requestId}/update-return-status`, returnData).then(response => {
    if (response.data.success) {
        showNotification('تم تسجيل عودتك بنجاح');
        updateCountdown();
    }
});
```

### مثال 5: تسجيل عدم عودة الموظف

المدير يلاحظ أن الموظف "أحمد" لم يعد من الاستئذان ويقوم بتسجيل ذلك يدوياً.

```javascript
// Frontend (تسجيل عدم العودة من قبل المدير)
const returnData = {
    return_status: 2  // 2 = لم يعد
};

axios.post(`/permission-requests/${requestId}/update-return-status`, returnData).then(response => {
    if (response.data.success) {
        showNotification('تم تسجيل عدم عودة الموظف وإضافة مخالفة');
    }
});
```

### مثال 6: عرض إحصائيات الاستئذان

مدير القسم يريد الاطلاع على إحصائيات استئذان فريقه.

```javascript
// Frontend (عرض الإحصائيات)
function loadStatistics() {
    const filterData = {
        date_start: '2023-10-01',
        date_end: '2023-10-31',
        team_id: currentTeamId
    };
    
    axios.get('/permission-requests/statistics', { params: filterData }).then(response => {
        renderStatisticsChart(response.data.statistics);
        updateTeamMembersTable(response.data.team_members);
        showRemainingMinutes(response.data.remaining_minutes);
    });
}
```

### مثال 7: تجاوز الحد المجاني للاستئذان

الموظف "خالد" استنفد الـ 180 دقيقة المجانية ويحتاج إلى استئذان إضافي:

```javascript
// الطلب بعد استنفاد الرصيد المجاني
const requestData = {
    departure_time: '2023-10-25 13:00:00',
    return_time: '2023-10-25 14:30:00',     // 90 دقيقة إضافية
    reason: 'مراجعة طبيب للضرورة'
};

// إرسال الطلب
axios.post('/permission-requests', requestData).then(response => {
    if (response.data.success) {
        if (response.data.exceeded_limit) {
            showWarning('تم إنشاء طلب الاستئذان بنجاح، ولكن تم تجاوز الحد المجاني الشهري.');
        } else {
            showNotification('تم إنشاء طلب الاستئذان بنجاح');
        }
    } else {
        showError(response.data.message);
    }
});
```

## ملاحظات هامة

1. لكل موظف 180 دقيقة استئذان مجانية شهرياً
2. يمكن للموظف تجاوز الـ 180 دقيقة الشهرية مع إمكانية تطبيق قواعد مختلفة حسب سياسة الشركة
3. يمكن تقديم طلب للنفس أو للموظفين (حسب الصلاحيات)
4. **تسجيل العودة يجب أن يتم يدوياً فقط** من قبل الموظف نفسه أو المدير/HR
5. يتم تسجيل المخالفات فقط عند تسجيل عدم العودة يدوياً من قبل المدير
6. تتم محاسبة الموظف إذا لم يعد في الوقت المحدد وتم تسجيل ذلك من قبل المسؤول
7. لا يمكن للموظف تعديل طلبه بعد الموافقة عليه

## دليل مرجعي سريع

- **إنشاء طلب**: `/permission-requests` (POST)
- **تعديل طلب**: `/permission-requests/{id}` (PUT)
- **حذف طلب**: `/permission-requests/{id}` (DELETE)
- **تحديث حالة**: `/permission-requests/{id}/update-status` (POST)
- **تسجيل العودة**: `/permission-requests/{id}/update-return-status` (POST)
- **عرض الإحصائيات**: `/permission-requests/statistics` (GET)

## وصف الملفات الرئيسية

### PermissionRequestService.php
خدمة تحتوي على منطق الأعمال لإدارة طلبات الاستئذان، بما في ذلك:
- إنشاء طلبات جديدة
- تحديث الطلبات القائمة
- التحقق من صلاحية أوقات الطلب
- حساب الدقائق المستخدمة والمتبقية
- تحديث حالات الطلبات
- التعامل مع تسجيل العودة
- إدارة المخالفات المتعلقة بالاستئذان

### PermissionRequest.php
نموذج البيانات الذي يمثل طلب الاستئذان ويحتوي على:
- العلاقات مع المستخدمين والمخالفات
- دوال التحقق من الصلاحيات
- دوال تحديث حالة الطلب
- دوال لحساب الوقت المستغرق
- دوال لإدارة عملية العودة من الاستئذان

### PermissionRequestController.php
وحدة التحكم التي تتعامل مع طلبات HTTP وتنسق بين الخدمات والنماذج، وتشمل:
- إدارة عرض طلبات الاستئذان
- معالجة عمليات إنشاء/تعديل/حذف الطلبات
- إدارة الموافقة/الرفض من قبل المدراء والموارد البشرية
- إدارة عمليات تسجيل العودة يدوياً
- عرض الإحصائيات وتقارير الاستئذان 
