# نظام إدارة طلبات الغياب

## نظرة عامة

نظام إدارة طلبات الغياب هو نظام متكامل لإدارة طلبات غياب الموظفين في المؤسسة، يتيح للموظفين تقديم طلبات الغياب، ويمكّن المديرين وفريق الموارد البشرية من مراجعة هذه الطلبات والموافقة عليها أو رفضها. يدعم النظام هيكل تنظيمي متعدد المستويات مع أدوار وصلاحيات مختلفة.

## المكونات الأساسية

### 1. نموذج البيانات (Model)

#### AbsenceRequest.php

يمثل نموذج `AbsenceRequest` طلب الغياب في قاعدة البيانات ويحتوي على:

- **الحقول الأساسية**:
  - `user_id`: معرف المستخدم مقدم الطلب
  - `absence_date`: تاريخ الغياب
  - `reason`: سبب الغياب
  - `status`: الحالة النهائية للطلب (pending, approved, rejected)
  - `manager_status`: حالة موافقة المدير
  - `hr_status`: حالة موافقة الموارد البشرية
  - `manager_rejection_reason`: سبب رفض المدير (إن وجد)
  - `hr_rejection_reason`: سبب رفض الموارد البشرية (إن وجد)

- **العلاقات**:
  - علاقة مع نموذج `User` (صاحب الطلب)

- **الدوال الرئيسية**:
  - `canRespond()`: التحقق من صلاحية المستخدم للرد على الطلب
  - `canCreate()`: التحقق من صلاحية المستخدم لإنشاء طلب
  - `canUpdate()`: التحقق من صلاحية المستخدم لتعديل الطلب
  - `canDelete()`: التحقق من صلاحية المستخدم لحذف الطلب
  - `canModifyResponse()`: التحقق من صلاحية المستخدم لتعديل الرد
  - `updateManagerStatus()`: تحديث حالة موافقة المدير
  - `updateHrStatus()`: تحديث حالة موافقة الموارد البشرية
  - `updateFinalStatus()`: تحديث الحالة النهائية بناءً على حالة المدير وحالة الموارد البشرية
  - `userHasTeam()`: التحقق ما إذا كان المستخدم ينتمي لفريق
  - `hasExceededLimit()`: التحقق ما إذا كان المستخدم قد تجاوز الحد المسموح به للغياب
  - `getRemainingDays()`: حساب الأيام المتبقية المسموح بها للغياب

### 2. خدمة طلبات الغياب (Service)

#### AbsenceRequestService.php

تحتوي خدمة `AbsenceRequestService` على منطق الأعمال لعمليات طلب الغياب:

- **الدوال الرئيسية**:
  - `getAllRequests()`: استرجاع جميع الطلبات (حسب دور المستخدم)
  - `getUserRequests()`: استرجاع طلبات المستخدم الحالي
  - `createRequest()`: إنشاء طلب غياب جديد
  - `createRequestForUser()`: إنشاء طلب غياب لمستخدم آخر (للمديرين و HR)
  - `updateRequest()`: تحديث طلب غياب قائم
  - `deleteRequest()`: حذف طلب غياب
  - `updateStatus()`: تحديث حالة الطلب (موافقة أو رفض)
  - `resetStatus()`: إعادة تعيين حالة الطلب إلى "معلق"
  - `modifyResponse()`: تعديل رد سابق على طلب
  - `canRespond()`: التحقق من صلاحية المستخدم للرد على الطلبات
  - `canModifyRequest()`: التحقق من صلاحية تعديل الطلب

### 3. متحكم طلبات الغياب (Controller)

#### AbsenceRequestController.php

يتعامل `AbsenceRequestController` مع طلبات HTTP ويربط المستخدم بمنطق الأعمال:

- **الدوال الرئيسية**:
  - `index()`: عرض صفحة الطلبات بما يتناسب مع دور المستخدم
  - `store()`: معالجة إنشاء طلب جديد
  - `update()`: معالجة تحديث طلب موجود
  - `destroy()`: معالجة حذف طلب
  - `updateStatus()`: معالجة تحديث حالة طلب
  - `modifyResponse()`: معالجة تعديل رد سابق
  - `resetStatus()`: معالجة إعادة تعيين حالة الطلب
  - `getStatistics()`: استخراج الإحصائيات الخاصة بالغياب
  - `getAllowedRoles()`: تحديد الأدوار المسموح بها للمستخدم
  - `getTeamMembers()`: استرجاع أعضاء الفريق بناءً على الأدوار المسموحة

### 4. واجهة المستخدم (Views)

#### الملفات الرئيسية:
- `index.blade.php`: الصفحة الرئيسية لعرض وإدارة طلبات الغياب
- `components/_table.blade.php`: عرض جداول طلبات الغياب المختلفة
- `components/_search.blade.php`: نموذج البحث والفلترة
- `components/_statistics.blade.php`: عرض الإحصائيات المتعلقة بالغياب
- `components/_modals.blade.php`: النوافذ المنبثقة لإنشاء/تعديل/الرد على الطلبات

### 5. سكريبت جافاسكريبت (JavaScript)

#### الملفات الرئيسية:
- `index.js`: التهيئة الأساسية والإعداد
- `common.js`: دوال وثوابت مشتركة
- `modals.js`: التعامل مع النوافذ المنبثقة والاستمارات
- `statistics.js`: عرض وتحليل إحصائيات الغياب
- `hr-charts.js`: رسوم بيانية متقدمة لفريق الموارد البشرية

## سير العمل (Workflow)

### تقديم طلب غياب:
1. يقوم الموظف بتعبئة نموذج طلب الغياب (التاريخ والسبب)
2. يتم حفظ الطلب بحالة "معلق" في قاعدة البيانات
3. يتم إرسال إشعار (إن وُجد) للمديرين المعنيين وفريق الموارد البشرية

### مسار الموافقة:
1. **موظف بدون فريق**:
   - يحتاج فقط موافقة الموارد البشرية للقبول النهائي
   
2. **موظف ضمن فريق**:
   - يحتاج موافقة المدير + موافقة الموارد البشرية للقبول النهائي
   - إذا رفض أي طرف، يتم رفض الطلب بشكل نهائي

### الردود على الطلبات:
- **المدير**: يمكنه الموافقة أو الرفض مع إضافة سبب الرفض
- **الموارد البشرية**: يمكنهم الموافقة أو الرفض مع إضافة سبب الرفض
- يمكن تعديل الردود أو إعادة تعيين الحالة لاحقاً

## الأدوار والصلاحيات

### الأدوار الرئيسية:
1. **الموظف (employee)**:
   - يمكنه تقديم طلبات الغياب الخاصة به
   - يمكنه تعديل/حذف طلباته المعلقة

2. **قائد الفريق (team_leader)**:
   - يمكنه الرد على طلبات أعضاء فريقه
   - يمكنه إنشاء طلبات غياب لأعضاء فريقه

3. **مدير القسم (department_manager)**:
   - يمكنه الرد على طلبات قادة الفرق والموظفين تحت إدارته
   - يمكنه إنشاء طلبات غياب للموظفين تحت إدارته

4. **مدير الشركة (company_manager)**:
   - يمكنه الرد على طلبات مديري الأقسام وقادة الفرق والموظفين تحت إدارته
   - لديه صلاحيات واسعة في إدارة طلبات الغياب

5. **موارد بشرية (hr)**:
   - يمكنه الرد على جميع طلبات الغياب
   - يمكنه مراجعة الإحصائيات والرسوم البيانية
   - يمكنه إنشاء طلبات غياب لجميع الموظفين

### الحالة الخاصة: مستخدم HR مالك فريق (Team Owner)
- عندما يكون مستخدم HR مالكًا لفريق ولديه صلاحية `manager_respond_absence_request`:
  - يمكنه الرد على طلبات الغياب كمدير (ستظهر له أزرار الرد كمدير)
  - يظهر في واجهة المستخدم خيارات الرد كمدير بالإضافة لخيارات الرد كـ HR
  - يتم التحقق من هذه الشروط عند عرض أزرار الرد على الطلبات
  - يمكنه تعديل/إعادة تعيين حالة الرد كمدير للطلبات الخاصة بأعضاء فريقه

- عندما لا تتوفر هذه الشروط:
  - يمكنه الرد كـ HR فقط (تظهر أزرار الرد كـ HR فقط)
  - لا يمكنه الوصول إلى وظائف الرد كمدير

### الصلاحيات الرئيسية:
- `create_absence`: إنشاء طلب غياب
- `update_absence`: تعديل طلب غياب
- `delete_absence`: حذف طلب غياب
- `manager_respond_absence_request`: الرد على طلب غياب كمدير
- `hr_respond_absence_request`: الرد على طلب غياب كموارد بشرية

## الإحصائيات والتقارير

### إحصائيات شخصية:
- إجمالي الطلبات المقدمة
- عدد الطلبات الموافق عليها/المرفوضة/المعلقة
- أيام الغياب المعتمدة
- أكثر أسباب الغياب شيوعاً

### إحصائيات الفريق (للمديرين):
- إجمالي طلبات الفريق
- عدد الطلبات الموافق عليها/المرفوضة/المعلقة للفريق
- عدد الموظفين الذين تجاوزوا الحد المسموح
- أكثر موظف تغيباً في الفريق

### إحصائيات الموارد البشرية:
- إحصائيات شاملة عن جميع الموظفين
- توزيع الغياب حسب الأقسام
- أسباب الغياب الأكثر شيوعاً
- توزيع الغياب حسب أيام الأسبوع
- توزيع الغياب حسب الفئات العمرية
- إحصائيات شهرية للغياب

## ملاحظات تطويرية

### معالجة أخطاء المترجم (Linter)
يظهر أن هناك أخطاء مرتبطة بالدوال `hasRole()` و `hasPermissionTo()` في الكود. هذه الدوال تأتي من حزمة Spatie's Laravel Permission وتحتاج إلى التأكد من:

1. تثبيت الحزمة: `composer require spatie/laravel-permission`
2. تطبيق trait في نموذج المستخدم:
   ```php
   use Spatie\Permission\Traits\HasRoles;
   
   class User extends Authenticatable
   {
       use HasRoles;
       // ...
   }
   ```

### إمكانيات التحسين

1. **الاختبارات (Testing)**:
   - إضافة اختبارات للتحقق من عمل القواعد والأدوار المختلفة

2. **التوثيق الفني**:
   - إضافة تعليقات PHPDoc لتحسين التوثيق ودعم الإكمال التلقائي

3. **الأداء**:
   - تحسين استعلامات قاعدة البيانات، خاصة في دوال الإحصائيات

4. **تجربة المستخدم**:
   - تحسين واجهة المستخدم لتسهيل التنقل وإدارة الطلبات
   - إضافة تنبيهات المتصفح للإشعارات 
